---
- hosts: reverseproxy
  tasks:
    - name: certbot installieren
      become: yes
      apt:
        name:
          - certbot
          - python3-certbot-nginx
        state: present
    # sudo certbot --nginx
    # https://certbot.eff.org/lets-encrypt/ubuntubionic-nginx
  roles:
    - { role: hispanico.letsencrypt-nginx-revproxy, tags: "letsencrypt-nginx-revproxy", become: true }
    # Variablen liegen unter roles/ansible-nginx-revproxy/vars/main.yml
  vars:
    nginx_revproxy_sites:
      #vhost fuer dokuwiki + der normale-domainname + letsencrypt-Zertifikat
      dokuwiki.mgrote.net:
        domains:
          - dokuwiki.mgrote.net
          - www.mgrote.net
          - mgrote.net
        upstreams:
          - { backend_address: dokuwiki2.grote.lan, backend_port: 80 }
        letsencrypt: true
        letsencrypt_email: "michael.grote@posteo.de"
      #vhost fuer miniflux + letsencrypt-Zertifikat
      miniflux.mgrote.net:
        domains:
          - miniflux.mgrote.net
        upstreams:
          - { backend_address: miniflux.grote.lan, backend_port: 8080 }
        letsencrypt: true
        letsencrypt_email: "michael.grote@posteo.de"
    telegraf_x509_domains: # im template wird die variable mit "|to_json}}" verwertet da sonst am anfang 'u und []' stehen
      - "https://mgrote.net:443" #port muss mit angegeben werden
      - "https://dokuwiki.mgrote.net:443"
      - "https://miniflux.mgrote.net:443"
      - "https://miniflux-staging.mgrote.net:443"
    telegraf_x509_metrics: true

##################################################
# der CNAME muss vorher eingerichtet werden!     #
##################################################
