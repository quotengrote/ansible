---
depends_on:
  - gitleaks
steps:
  ansible-lint:
    image: quay.io/ansible/creator-ee
    commands:
      - ansible-lint --version
      - echo $VAULT-PASS > ./vault-pass.yml # nach des Secret in Gro√üschreibung
      - ansible-galaxy install -r requirements.yml
      - ansible-lint --force-color --format pep8
    when:
      event:
        exclude:
          - tag
    secret: [vault-pass] #dieses Secret darf verwendet werden

  notify:
    name: notify
    image: deblan/woodpecker-email
    settings:
      dsn: "smtp://docker10.mgrote.net:1025"
      from:
        address: "ci@mgrote.net"
        name: "woodpecker"
      recipients:
        - info@mgrote.net
      content:
        subject: "[{{ pipeline.status }}] {{ repo.full_name }} ({{ commit.branch }} - {{ commit.sha[0:8] }}"
        body: |
          {{ commit.sha }}<br>
          {{ pipeline.status }}<br>
          {{ commit.author_email }}<br>
      attachments:
        - log/*
    when:
      status:
        - failure
